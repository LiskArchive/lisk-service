version: "3"
services:

  mysql-primary:
    image: mysql:8
    platform: linux/amd64
    command: mysqld --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max_connections=500
    volumes:
      - ../../docker/mysql/primary/conf/mysql.conf.cnf:/etc/mysql/conf.d/mysql.conf.cnf
      - mysql-primary-data:/var/lib/mysql
      - ../../docker/mysql/primary/init:/docker-entrypoint-initdb.d
    restart: always
    networks:
      - services_network
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_USER=lisk
      - MYSQL_PASSWORD=password
    ports:
      - "127.0.0.1:3306:3306"
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-hlocalhost",
          "-ppassword"
        ]
      timeout: 20s
      retries: 10

  mysql-replica:
    image: mysql:8
    depends_on:
      mysql-primary:
        condition: service_healthy
    platform: linux/amd64
    command: mysqld --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max_connections=500
    volumes:
      - ../../docker/mysql/read/conf/mysql.conf.cnf:/etc/mysql/conf.d/mysql.conf.cnf
      - mysql-replica-data:/var/lib/mysql
      - ../../docker/mysql/read/init:/docker-entrypoint-initdb.d
    restart: always
    networks:
      - services_network
    environment:
      - MYSQL_ROOT_PASSWORD=password
    ports:
      - "127.0.0.1:3307:3306"
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-hlocalhost",
          "-ppassword"
        ]
      timeout: 20s
      retries: 10

networks:
  services_network:

volumes:
  mysql-primary-data:
  mysql-replica-data:
